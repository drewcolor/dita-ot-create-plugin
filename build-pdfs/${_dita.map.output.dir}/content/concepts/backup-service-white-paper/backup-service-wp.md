---
title: SMTX OS 备份服务白皮书
BookShowToc: false
alias: [/concepts/backup-service-white-paper.md]
---

# 概述

SMTX OS 备份功能的设计目标是为 SMTX 集群提供更为强大的数据容灾、恢复和回溯能力。备份功能以 SMTX 的快照功能为基础，可以将数据在不同时刻的快照副本自动复制至其他城市的目标站点中。在需要时，可以使用目标站点的备份数据对原始站点的保护对象进行回滚操作，并且在原始数据所在站点崩溃时，可以迅速地从目标站点中利用最近时刻的快照重建业务。此外，备份功能还提供了数据对象跨站点克隆的能力。

## 目标读者

本文面对想了解更多 SMTX OS 备份服务架构设计和工作原理的读者。

## 术语及缩略语

本文中使用到的术语与缩略语如下：

| **术语** | **描述**                                                     |
| :----------------- | :------------------------------------------------------------ |
| 保护站点          | 备份功能的主站点。保护站点内的数据可通过备份功能在远端备份，站点代表一个独立的 SMTX 集群。 |
| 目标站点          | 保护计划中数据备份的目的地。目标站点与保护站点需要在同一个多集群模块管理范围之内。一个保护计划允许指定 0\~n 个目标站点。当不指定目标站点时，保护计划将被称为快照计划。目标站点亦称为备份站点或远程站点。 |
| 保护计划          | 快照计划和备份计划的统称。它是对备份任务的描述，主要包含保护对象、保护策略与目标站点。当不指定目标站点时，保护计划被称为快照计划，仅在保护站点内执行定时快照任务；当指定目标站点时，保护计划将按照指定策略将保护站点内产生的快照组复制至目标站点，此时保护计划被称为备份计划。目前的设计中不允许快照计划和备份计划之间做转化。 |
| 外来备份计划      | 当保护站点的数据被异步复制到目标站点时，对应于源保护计划，在目标站点上将会生成外来备份计划，用来标示在目标站点上这块数据的类型和用途，防止目标站点修改外来备份计划所管理的数据，也可方便目标站点数据在保护站点崩溃时，用目标站点的备份数据在保护站点上进行重建。 |
| 保护策略          | 保护策略定义了执行保护计划的周期、频率、快照/备份数据的保留份数等。 |
| 快照组            | 快照组代表保护计划一次执行时所关联的保护对象的整体数据状态。 |
| 多集群            | SMTX OS 提供的多个 SMTX 的集群统一管理模式。在这个模式下可以通过同一个控制台（即 SMTX OS Web Console）管理多集群内的所有集群。 |

# 架构与核心组件

备份服务的架构图如下：

![备份服务架构图](backup-service-architecture.jpg)

## Time Machine

Time Machine 是备份服务的主体模块，负责保护计划的维护、任务调度、资源监控等，也负责在异地备份站点中创建受保护对象的镜像对象。它按照预设的保护周期在保护站点中创建快照组，再将快照组内的数据写入至异地备份站点的镜像对象中。在数据传输完成之后，它再对备份站点中的镜像对象执行一次快照，得到镜像快照组。用户需要时可以从保护计划的执行记录中找到对应的快照组，选择回滚或者远程重建恢复当时的数据状态。在每次成功执行保护计划之后，Time Machine 还将按照指定的保留策略，清理过期快照组。

Time Machine 部署在所有节点上。它们借助 ZooKeeper 以集群的形式对外提供服务，同一时刻有且仅有一个节点的 Time Machine 会成为 Leader 执行业务逻辑。其他节点都将成为 Follower，这个状态的 Timemachine 都可以接受外部请求，并将其转发至 Leader 节点执行，这样便确保从集群上任一节点均可访问 Time Machine 服务。

## Task Server

Task Server 是 SMTX OS 的块存储服务（ 内部项目代号为 ZBS）的异步长任务处理模块。提供诸如存储池间移动/复制数据、远端备份的数据复制等耗时较长的长任务处理服务。多台 Task Server 组成 Task 集群。经由 ZooKeeper 选出唯一的 Task Leader 负责任务的调度分发，其余 Task Server 只作为 Runner 实际运行长任务。

在备份服务中，Task Server 负责保护计划任务的具体执行。保护站点的 Task Server 将通过 Envoy 提供的远端接入服务来访问异地备份站点的块（block）服务，直接对数据进行操作。此模块只处理存储卷和快照的备份、克隆、回滚等数据层的任务，不处理关联的元数据信息。

## Envoy

Envoy 是一个专为大型现代服务导向架构设计的 L7 代理和通讯总线。Envoy 是一个独立的进程，旨在与每个应用程序服务器并行运行。所有的 Envoy 形成一个透明的通信网格，每个应用程序发送和接收来自本地主机的消息，并且不知道网络的拓扑结构。Time Machine 利用 Envoy 管理与 ZBS 集群及远端站点的链路维护。在两个站点之间的 Envoy 将使用 SSL 加密通道进行传输。

欲了解更多关于 Envoy 的信息，请参见 [Envoy Proxy](https://www.envoyproxy.io/)。

## 保护计划

备份服务以保护计划（Protection Plan）的形式对保护资源进行管理。一个保护计划包括以下几个部分：

1.  保护对象：备份服务目前支持指定以下 4 种保护对象：

    a.  iSCSI LUN：在目标站点的指定存储池内创建 LUN 所属的 Target 的镜像 Target，在该 Target 内创建 ID 相同的 LUN；

    b.  NFS 文件：在目标站点内创建文件所属的 Export 对应的镜像 Export 与目录，目标站点的文件名与存储路径将于保护站点相同；

    c.  虚拟卷：保护虚拟卷时，如果虚拟卷所挂载的虚拟机不在保护对象内，则目标站点将仅备份虚拟卷，而不包含虚拟机隶属关系；

    d.  虚拟机：目标站点将创建保护站点中虚拟机的镜像虚拟机，其资源配置与源虚拟机保持一致（包括虚拟机的虚拟卷/网络配置信息，但不包括虚拟机所挂载的 CD-ROM 与共享卷 ；

2.  保护周期：保护计划的自动执行周期，目前支持小时、天、周和月 4 种不同粒度的执行周期，并且可以指定保护计划的自动中止时间；

3.  目标站点：保护计划可以在由同一个多集群管理的站点中选择若干站点作为目标站点。备份计划配置阶段需要检查确认所有保护对象所关联的虚拟交换机已指定了映射关系。不指定目标站点时，保护计划称之为快照计划；指定目标站点时，保护计划称之为备份计划；

4.  保留策略：允许为本地（快照计划时）或每个目标站点（备份计划时）的数据副本指定不同的快照组保留份数，保留策略的修改在下次触发回收检查时生效；

每个保护计划执行时会在每个目标站点创建所有保护对象的镜像对象，并在目标站点中创建一个外来备份计划管理这些镜像对象。每次备份时，数据传输将在原始保护对象的快照和镜像对象之间进行。

这些镜像对象在目标站点中是不可操作的。

# 数据链路

保护站点和目标站点之间通过 Envoy 构建数据链路：

![数据链路](backup-service-data-path.png)

每个站点内的所有 ZBS 和 Time Machine 服务都会向 Envoy 注册，由 Envoy 提供服务的统一访问地址。当用户访问某一特定服务（例如 Timemachine），Envoy 会通过轮询的方式将其指向之前注册的某一服务节点。在服务节点异常时，可以通过重试机制（默认不超过 10 次），从 Envoy 处获得一条新的可用的链路。Envoy 服务部署在集群中的所有节点，其中部分站点具备外部可访问的 IP。其他站点可以通过对外服务 IP 节点上的 Envoy 来访问本集群内的各项服务。

站点间 Envoy 链路会采用 SSL 安全通道进行数据传输。

# 工作原理

## 基本原理

备份的目标是将数据的当前状态完整地复制到指定的位置。 SMTX OS 的备份模块借助 ZBS 的快照功能来达成这个目标。

备份被拆分为三个主要步骤：

1.  获取当前数据状态。通过快照功能，备份模块可以获取当前的所有保护对象的在同一时刻内的状态（存在微秒级误差），后续单个数据对象的更新将不会影响到需要备份的数据快照；

2.  配置同步。备份功能所备份的不仅仅是数据本身，也包括了数据的组织状态，例如虚拟机的配置信息、文件的目录结构等等。在备份开始之前，会首先在保护站点和目标站点之间进行保护对象的配置信息同步，确保在目标站点内创建出所有保护对象的镜像对象；

3.  数据同步。在保护站点与目标站点间传输数据快照。

备份模块的克隆与回滚功能的实现原理与备份类似，基本流程均是从快照组中重建数据对象。

## 传输速率与空间优化

备份通常运行在两个距离较远的站点之间，它们之间的带宽通常较小。为了尽可能充分地利用带宽，减少传输时间，备份功能采用如下策略组合来降低传输的数据量：

1.  增量备份：如果保护站点和目标站点曾经完成过一次备份任务，后续任务执行时，都会采用增量备份的方式进行。每次传输的数据仅是当前需要传输的快照组与目标站点已有快照组之间的增量，在数据更新不频繁或更新区域较为集中的场景下可以很大程度地减少传输量；

2.  Rsync 同步模式：在变化的数据量中，也会在固定区块内（256MB， ZBS extent 大小）采用 Rsync 模式同步增量，尽可能地利用目标站点已有的数据；

3.  空洞避免：在传输时将跳过未写入过的虚拟卷空间，避免传输大量无用数据；

4.  数据压缩：多集群间数据备份场景下，在源集群将需要备份的数据进行压缩后再进行网络传输，到备份集群进行解压后备份储存。压缩算法使用 Zstandard，该功能默认开启。

同时为降低备份空间成本，目标站点中的数据组织形态为快照链。对于不同时刻快照组间的重复数据将仅保留一份逻辑数据，以减少不必要的空间损耗。同时各个时刻的快照组在逻辑上依旧完整地持有所有数据。删除某个快照对其他快照的数据完整性不会产生影响。

# 高可靠与高可用

SMTX OS 备份服务被设计为集群模式，以下故障均不会影响到备份功能的正常运行：

1.  Timemachine Follower 故障重启：如果访问的是该节点的 Web Console ，那么页面上的备份功能将会有短暂时间不可访问（< 20 秒 ）。后台任务不受影响；

2.  Timemachine Leader 故障切换：集群的备份服务将有短暂时间不可访问（< 20 秒），但是所有的保护计划和任务信息将不会丢失。所有正在运行的任务也将在新的 Leader 启动后继续恢复运行状态；

3.  链路异常：当两个站点间的网络异常时，备份任务会进行几次（默认最多10 次）重试。如果持续失败，向异常站点的备份任务将会失败，但是不会影响到同一个保护计划中指定的其他站点的备份任务；

4.  链路迟缓：备份功能没有为每个备份任务指定最大执行时间上限，如果站点间的链路带宽不能满足指定的保护周期，那么备份任务会自动调整为实际可行的周期进行备份。例如站点间带宽仅能满足 2 个小时传输一次备份数据的需要，那么即便为备份任务指定了 1 小时 1 次的备份周期，备份功能也会退化为 2 小时 1 次，但是会尽量地保证最新的快照组得到备份。
