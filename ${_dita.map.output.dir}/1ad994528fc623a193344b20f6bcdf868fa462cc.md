<?xml version="1.0" encoding="UTF-8"?><?workdir /C:\Users\Admin\AppData\Local\Temp\temp20190704194217826?><?workdir-uri file:/C:/Users/Admin/AppData/Local/Temp/temp20190704194217826/?><?path2project ..\..\..\?><?path2project-uri ../../../?><?path2rootmap-uri ../../../?><topic xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/" xmlns:dita-ot="http://dita-ot.sourceforge.net/ns/201007/dita-ot" class="- topic/topic " ditaarch:DITAArchVersion="1.2" domains="(topic hi-d) (topic ut-d) (topic indexing-d) (topic hazard-d) (topic abbrev-d) (topic pr-d) (topic sw-d) (topic ui-d)" id="架构与核心组件" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="topic:1;182:3"><title class="- topic/title " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="title:1;182:3">架构与核心组件</title><body class="- topic/body " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="body:1;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:1;182:3">备份服务的架构图如下：</p><image class="- topic/image " href="f87caa271d496a4986947cfc7bf4bfca419fa0a5.jpg" placement="break" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="image:1;182:3"><alt class="- topic/alt " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="alt:1;182:3">备份服务架构图</alt></image></body><topic class="- topic/topic " ditaarch:DITAArchVersion="1.2" domains="(topic hi-d) (topic ut-d) (topic indexing-d) (topic hazard-d) (topic abbrev-d) (topic pr-d) (topic sw-d) (topic ui-d)" id="time-machine" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="topic:2;182:3"><title class="- topic/title " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="title:2;182:3">Time Machine</title><body class="- topic/body " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="body:2;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:2;182:3">Time Machine 是备份服务的主体模块，负责保护计划的维护、任务调度、资源监控等，也负责在异地备份站点中创建受保护对象的镜像对象。它按照预设的保护周期在保护站点中创建快照组，再将快照组内的数据写入至异地备份站点的镜像对象中。在数据传输完成之后，它再对备份站点中的镜像对象执行一次快照，得到镜像快照组。用户需要时可以从保护计划的执行记录中找到对应的快照组，选择回滚或者远程重建恢复当时的数据状态。在每次成功执行保护计划之后，Time Machine 还将按照指定的保留策略，清理过期快照组。</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:3;182:3">Time Machine 部署在所有节点上。它们借助 ZooKeeper 以集群的形式对外提供服务，同一时刻有且仅有一个节点的 Time Machine 会成为 Leader 执行业务逻辑。其他节点都将成为 Follower，这个状态的 Timemachine 都可以接受外部请求，并将其转发至 Leader 节点执行，这样便确保从集群上任一节点均可访问 Time Machine 服务。</p></body></topic><topic class="- topic/topic " ditaarch:DITAArchVersion="1.2" domains="(topic hi-d) (topic ut-d) (topic indexing-d) (topic hazard-d) (topic abbrev-d) (topic pr-d) (topic sw-d) (topic ui-d)" id="task-server" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="topic:3;182:3"><title class="- topic/title " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="title:3;182:3">Task Server</title><body class="- topic/body " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="body:3;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:4;182:3">Task Server 是 SMTX OS 的块存储服务（ 内部项目代号为 ZBS）的异步长任务处理模块。提供诸如存储池间移动/复制数据、远端备份的数据复制等耗时较长的长任务处理服务。多台 Task Server 组成 Task 集群。经由 ZooKeeper 选出唯一的 Task Leader 负责任务的调度分发，其余 Task Server 只作为 Runner 实际运行长任务。</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:5;182:3">在备份服务中，Task Server 负责保护计划任务的具体执行。保护站点的 Task Server 将通过 Envoy 提供的远端接入服务来访问异地备份站点的块（block）服务，直接对数据进行操作。此模块只处理存储卷和快照的备份、克隆、回滚等数据层的任务，不处理关联的元数据信息。</p></body></topic><topic class="- topic/topic " ditaarch:DITAArchVersion="1.2" domains="(topic hi-d) (topic ut-d) (topic indexing-d) (topic hazard-d) (topic abbrev-d) (topic pr-d) (topic sw-d) (topic ui-d)" id="envoy" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="topic:4;182:3"><title class="- topic/title " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="title:4;182:3">Envoy</title><body class="- topic/body " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="body:4;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:6;182:3">Envoy 是一个专为大型现代服务导向架构设计的 L7 代理和通讯总线。Envoy 是一个独立的进程，旨在与每个应用程序服务器并行运行。所有的 Envoy 形成一个透明的通信网格，每个应用程序发送和接收来自本地主机的消息，并且不知道网络的拓扑结构。Time Machine 利用 Envoy 管理与 ZBS 集群及远端站点的链路维护。在两个站点之间的 Envoy 将使用 SSL 加密通道进行传输。</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:7;182:3">欲了解更多关于 Envoy 的信息，请参见 <xref class="- topic/xref " href="https://www.envoyproxy.io/" format="html" scope="external" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="xref:1;182:3">Envoy Proxy</xref>。</p></body></topic><topic class="- topic/topic " ditaarch:DITAArchVersion="1.2" domains="(topic hi-d) (topic ut-d) (topic indexing-d) (topic hazard-d) (topic abbrev-d) (topic pr-d) (topic sw-d) (topic ui-d)" id="保护计划" xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="topic:5;182:3"><title class="- topic/title " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="title:5;182:3">保护计划</title><body class="- topic/body " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="body:5;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:8;182:3">备份服务以保护计划（Protection Plan）的形式对保护资源进行管理。一个保护计划包括以下几个部分：</p><ol class="- topic/ol " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="ol:1;182:3"><li class="- topic/li " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="li:1;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:9;182:3">保护对象：备份服务目前支持指定以下 4 种保护对象：</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:10;182:3">a.  iSCSI LUN：在目标站点的指定存储池内创建 LUN 所属的 Target 的镜像 Target，在该 Target 内创建 ID 相同的 LUN；</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:11;182:3">b.  NFS 文件：在目标站点内创建文件所属的 Export 对应的镜像 Export 与目录，目标站点的文件名与存储路径将于保护站点相同；</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:12;182:3">c.  虚拟卷：保护虚拟卷时，如果虚拟卷所挂载的虚拟机不在保护对象内，则目标站点将仅备份虚拟卷，而不包含虚拟机隶属关系；</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:13;182:3">d.  虚拟机：目标站点将创建保护站点中虚拟机的镜像虚拟机，其资源配置与源虚拟机保持一致（包括虚拟机的虚拟卷/网络配置信息，但不包括虚拟机所挂载的 CD-ROM 与共享卷 ；</p></li><li class="- topic/li " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="li:2;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:14;182:3">保护周期：保护计划的自动执行周期，目前支持小时、天、周和月 4 种不同粒度的执行周期，并且可以指定保护计划的自动中止时间；</p></li><li class="- topic/li " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="li:3;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:15;182:3">目标站点：保护计划可以在由同一个多集群管理的站点中选择若干站点作为目标站点。备份计划配置阶段需要检查确认所有保护对象所关联的虚拟交换机已指定了映射关系。不指定目标站点时，保护计划称之为快照计划；指定目标站点时，保护计划称之为备份计划；</p></li><li class="- topic/li " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="li:4;182:3"><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:16;182:3">保留策略：允许为本地（快照计划时）或每个目标站点（备份计划时）的数据副本指定不同的快照组保留份数，保留策略的修改在下次触发回收检查时生效；</p></li></ol><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:17;182:3">每个保护计划执行时会在每个目标站点创建所有保护对象的镜像对象，并在目标站点中创建一个外来备份计划管理这些镜像对象。每次备份时，数据传输将在原始保护对象的快照和镜像对象之间进行。</p><p class="- topic/p " xtrf="file:/d:/safehaven/content/concepts/backup-service-white-paper/架构与核心组件.md" xtrc="p:18;182:3">这些镜像对象在目标站点中是不可操作的。</p></body></topic></topic>